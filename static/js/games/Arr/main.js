// Generated by CoffeeScript 1.12.7
(function() {
  var ArrWS, Bullet, Field, Life, Player, bulletImage, cordToCord, field, fieldHeight, fieldWidth, playerImages, winAdditionalWidth, winFieldHeight, winFieldWidth,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  cordToCord = function(x, y, k) {
    return [Math.floor(x * winFieldWidth / fieldWidth) + k, Math.floor(y * winFieldHeight / fieldHeight) + k];
  };

  window.cordToCord = cordToCord;

  Field = (function() {
    function Field(canvas, width, height) {
      this.canvas = canvas;
      this.width = width;
      this.height = height;
      this.ctx = this.canvas.getContext('2d');
      this.canvasWidth = this.canvas.width = winFieldWidth + winAdditionalWidth;
      this.canvasHeight = this.canvas.height = winFieldHeight;
      this.dotsColor = "173, 192, 219";
      this.players = [];
      this.bullets = [];
    }

    Field.prototype.drawDots = function() {
      var i, j, l, ref, results, x, y;
      results = [];
      for (i = l = 0, ref = fieldWidth; 0 <= ref ? l < ref : l > ref; i = 0 <= ref ? ++l : --l) {
        results.push((function() {
          var m, ref1, results1;
          results1 = [];
          for (j = m = 0, ref1 = fieldHeight; 0 <= ref1 ? m < ref1 : m > ref1; j = 0 <= ref1 ? ++m : --m) {
            x = Math.floor(Math.floor(winFieldWidth / this.width) / 2) + Math.floor(i * winFieldWidth / this.width);
            y = Math.floor(Math.floor(winFieldHeight / this.height) / 2) + Math.floor(j * winFieldHeight / this.height);
            this.ctx.beginPath();
            this.ctx.arc(x, y, 1, 0, 2 * Math.PI);
            this.ctx.fillStyle = "rgb(" + this.dotsColor + ")";
            results1.push(this.ctx.fill());
          }
          return results1;
        }).call(this));
      }
      return results;
    };

    Field.prototype.addNewPlayer = function(id, user) {
      return this.players.push(new Player(0, 0, id, this, user));
    };

    Field.prototype.update = function(players, bullets) {
      var bullet, i, l, len, len1, m, par, player, up_player;
      for (l = 0, len = players.length; l < len; l++) {
        player = players[l];
        if (!player.life) {
          continue;
        }
        up_player = this.players[player.id];
        for (par in player) {
          up_player[par] = player[par];
        }
      }
      for (i = m = 0, len1 = bullets.length; m < len1; i = ++m) {
        bullet = bullets[i];
        this.bullets[i].x = bullet.x;
        this.bullets[i].y = bullet.y;
        this.bullets[i].direction = bullet.direction;
      }
      return this.draw();
    };

    Field.prototype.draw = function() {
      var bullet, l, len, len1, m, player, ref, ref1, results;
      this.ctx.clearRect(0, 0, this.canvasWidth, this.canvasHeight);
      this.ctx.globalAlpha = 1;
      this.drawDots();
      ref = this.players;
      for (l = 0, len = ref.length; l < len; l++) {
        player = ref[l];
        player.draw();
        player.life.draw();
      }
      ref1 = this.bullets;
      results = [];
      for (m = 0, len1 = ref1.length; m < len1; m++) {
        bullet = ref1[m];
        results.push(bullet.draw());
      }
      return results;
    };

    return Field;

  })();

  Player = (function() {
    function Player(x1, y1, id1, field1, user1) {
      var ref;
      this.x = x1;
      this.y = y1;
      this.id = id1;
      this.field = field1;
      this.user = user1;
      this.life = new Life(10, this.id, this.field, this.user);
      this.direction = 0;
      this.width = Math.floor(winFieldWidth / fieldWidth) - 2;
      this.height = Math.floor(winFieldHeight / fieldHeight) - 2;
      ref = cordToCord(this.x, this.y, 2), this.real_x = ref[0], this.real_y = ref[1];
    }

    Player.prototype.draw = function() {
      var ref;
      ref = cordToCord(this.x, this.y, 2), this.real_x = ref[0], this.real_y = ref[1];
      this.field.ctx.rotate(this.direction * 90 * Math.PI / 180);
      this.field.ctx.drawImage(playerImages[this.id], this.real_x, this.real_y, this.width, this.height);
      return this.field.ctx.restore();
    };

    return Player;

  })();

  Bullet = (function() {
    function Bullet(x1, y1, direction, field1) {
      var ref;
      this.x = x1;
      this.y = y1;
      this.direction = direction;
      this.field = field1;
      ref = cordToCord(this.x, this.y, 3), this.real_x = ref[0], this.real_y = ref[1];
      this.width = Math.floor(winFieldWidth / fieldWidth) - 8;
      this.height = Math.floor(winFieldHeight / fieldHeight) - 8;
    }

    Bullet.prototype.draw = function() {
      var ref;
      ref = cordToCord(this.x, this.y, 2), this.real_x = ref[0], this.real_y = ref[1];
      this.field.ctx.rotate(this.direction * 90 * Math.PI / 180);
      this.field.ctx.drawImage(bulletImage, this.real_x, this.real_y, this.width, this.height);
      return this.field.ctx.restore();
    };

    return Bullet;

  })();

  Life = (function() {
    function Life(life, id1, field1, user1) {
      this.life = life;
      this.id = id1;
      this.field = field1;
      this.user = user1;
    }

    Life.prototype.draw = function() {};

    return Life;

  })();

  ArrWS = (function(superClass) {
    extend(ArrWS, superClass);

    function ArrWS() {
      return ArrWS.__super__.constructor.apply(this, arguments);
    }

    ArrWS.prototype.auth_ok = function(data) {
      ArrWS.__super__.auth_ok.call(this, data);
      return this.send('join', 'test');
    };

    ArrWS.prototype.do_action = function(data) {
      return this.send('action', {
        'action_type': 'do_action',
        'direction': data
      });
    };

    ArrWS.prototype.success_join = function(data) {
      var l, len, player, ref;
      ArrWS.__super__.success_join.call(this, data);
      ref = Object.values(data.players);
      for (l = 0, len = ref.length; l < len; l++) {
        player = ref[l];
        field.addNewPlayer(player.id, player.player_information);
      }
      return $(document).keydown((function(_this) {
        return function(event) {
          if (event.which === 37) {
            _this.do_action('left');
          }
          if (event.which === 39) {
            _this.do_action('right');
          }
          if (event.which === 38) {
            _this.do_action('up');
          }
          if (event.which === 40) {
            _this.do_action('down');
          }
          if (event.which === 32) {
            return _this.do_action('shoot');
          }
        };
      })(this));
    };

    ArrWS.prototype.new_player_connected = function(data) {
      ArrWS.__super__.new_player_connected.call(this, data);
      return field.addNewPlayer(data.id, data.player_information);
    };

    ArrWS.prototype.tick_passed = function(data) {
      return field.update(data.players, data.bullets);
    };

    return ArrWS;

  })(WSClient);

  winFieldWidth = 400;

  winFieldHeight = 400;

  winAdditionalWidth = 200;

  fieldWidth = 20;

  fieldHeight = 20;

  bulletImage = new Image();

  bulletImage.src = 'static/img/games/Arr/bullet.png';

  window.playerImages = playerImages = [new Image(), new Image()];

  playerImages[0].src = 'static/img/games/Arr/player1.png';

  playerImages[1].src = 'static/img/games/Arr/player2.png';

  field = new Field(document.getElementById('canvas'), fieldWidth, fieldHeight);

  window.field = field;

  window.ArrWS = ArrWS = new ArrWS();

}).call(this);

//# sourceMappingURL=main.js.map
